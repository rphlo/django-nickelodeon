<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Nickelodeon</title>
    <link href="data:image/x-icon;base64,AAABAAEAEBAAAAAAAABoBQAAFgAAACgAAAAQAAAAIAAAAAEACAAAAAAAAAEAAAAAAAAAAAAAAAEAAAAAAAAAAAAAJiUoACAfIwAfHiEAJSQmAB4dHwBFREYAHx0iAB0cIAAfHiIAHx4gAB8dIwAgHyAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADAcLCQAAAAAAAAAAAAAACQkJCQkFAAAAAAAAAAAAAAEJCQkJCQYAAAAAAAAAAAAJCQkJCQkJAAAAAAAAAAAAAAkICgUFCQAAAAAAAAAAAAAAAAAACQkAAAAAAAAAAAAAAAAAAAkJAAAAAAAAAAAAAAAAAAAJCQAAAAAAAAAAAAAAAAAACQIAAAAAAAAAAAAAAAAAAAkCAAAEAAAAAAAAAAAAAAAJCQAACQAAAAAAAAAAAAAACQkACQkAAAAAAAAAAAAAAAkJAwoAAAAAAAAAAAAAAAAJCQUAAAAAAAAAAAAAAAAACQkAAAAAAAAAAAAAAAAAAAkJAAAAAAAAAOH/AADA/wAAwH8AAMB/AADgfwAA/n8AAP5/AAD+fwAA/n8AAP5vAAD+bwAA/k8AAP4fAAD+PwAA/n8AAP5/AAA=" rel="icon" type="image/x-icon" />
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:600" rel="stylesheet">
    <style>
    html {
        height: 100%;
        width: 100%;
    }
    body {
        background:#3f3f3f url('background_optimized.jpg') no-repeat;
        -webkit-background-size: cover;
        -moz-background-size: cover;
        -o-background-size: cover;
        background-size: cover;
        background-position: 50% 50%;
        display: flex;
        background-attachment: fixed;
    }
    pre {
        font-family: 'Source Sans Pro', sans-serif;
        font-size: calc(1em + 1vw);
        text-shadow: 1px 1px #000000;
        color: #ccc;
    }
    a {
        text-decoration: none;
        color: #ccc;
    }
    input[type="text"], input[type="password"] {
        background-color: transparent;
        color: #ccc;
        border: 0px;
        padding: 0px;
        margin: 0px;
        font-family: 'Source Sans Pro', sans-serif;
        font-size: calc(1em + 1vw);
        text-shadow: 1px 1px #000000;
    }
    .progressbar {
        position: absolute;
        top:0px;
        left:0px;
        width: 100%;
        height:20px;
    }
    .progressbarbar {
        height:5px;
        background-color: #ccc;
    }

    button {
        background-color: #333;
        border: none;
        color: #ccc;
        padding: 5px 15px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        cursor: pointer;
        font-size: calc(.5em + 1vw);
        text-shadow: 1px 1px #000000;
    }
    
    </style>
</head>
<body>
<pre id="login">
    <input type="text" id="username" placeholder="Username" />
    <input type="password" id="password" placeholder="Password"/>
    <button id="login_btn">Login</button>
</pre>
<pre id="jukebox">
<a href="#" onclick="togglePause();return false;"><i class="fa fa-pause"></i></a> <a href="#" onclick="playNextSong();return false;"><i class="fa fa-forward"></i></a> <a href="#" onclick="promptYoutubeURL();return false;"><i class="fa fa-youtube"></i></a> <a href="#" onclick="toggleHardcore();return false;" id="hardcoreSwitch"><i class="fa fa-heart-o"></i></a>
Now Playing: <span id="currentTitle">-</span>
Queue
<div id="queuedSongs">-</div>
<input type="text" onChange="onSearchInputChange();" id="searchInput" placeholder="Search"/>
<div id="searchResults"></div>
</pre>
<div class="progressbar" id="seekBar"><div class="progressbarbar"></div></div>
<script src="https://code.jquery.com/jquery-3.1.0.min.js"
        integrity="sha256-cCueBR6CsyA4/9szpPfrX3s49M9vUU5BgtiJj06wt/s="
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/soundmanager2/2.97a.20150601/script/soundmanager2-nodebug.js"
        integrity="sha384-6RH4ezPrPwFe2n6HTRSlxynJwFgJyOGT66YzDey2DM9X+hTryEjdSvws2FB9WfAw" 
        crossorigin="anonymous"></script>
<script>
    var Song = function(path, filename, has_aac){
        this.path = path;
        this.filename = filename;
        this.has_aac = has_aac;
        var title_matches = filename.match(/[^\/]+$/)
        this.title = title_matches[0];
        this.play = function(){
            if(!hardcore && this.filename.startsWith('rphl/Happy Hardcore/')){
                playNextSong();
                return;
            }
            console.log('Playing '+this.filename);
            var mySound = soundManager.createSound({
                url: this.path + '.' + prefered_format+'?auth_token='+auth_token
            });
            mySound.play({onfinish: playNextSong, whileplaying: scrollProgressBar});
            $('#currentTitle').text(this.title).attr('title', this.filename)
        };
    }

    var scrollProgressBar = function(){
        var sound_id = soundManager.soundIDs[0];
        var sound = soundManager.getSoundById(sound_id);
        var perc = sound.position/sound.durationEstimate*100;
        $('#seekBar > .progressbarbar').css('width', perc+'%');
    }

    var togglePause = function(){
        var sound_id = soundManager.soundIDs[0];
        soundManager.togglePause(sound_id);
    }

    var stopSounds = function(){
        soundManager.stopAll();
        while(soundManager.soundIDs.length>0){
            soundManager.destroySound(soundManager.soundIDs[0]);        
        }
    }

    var songs = [];
    var queue = [];
    var prefered_format = 'mp3';
    var hardcore = false;
    
    var toggleHardcore = function(){
        if(hardcore){
            $('#hardcoreSwitch').html('<i class="fa fa-heart-o"></i>');
        }else{
            $('#hardcoreSwitch').html('<i class="fa fa-heartbeat"></i>');
        }
        hardcore = !hardcore;
    }
    var auth_token = null;

    $(document).ready(function(){
        askLogin();
        $('#login_btn').on('click', function(){
            var username = $('#username').val();
            var password = $('#password').val();

            $.ajax({
                url: '/api/auth_token/',
                data: {
                    username: username,
                    password: password
                },
                dataType: 'json',
                method: 'POST'
            }).done(function(e){
                auth_token = e.token;
                startJukebox();
            }).fail(function(){
                $('#password').val('')
            })
        })
    });

    var startJukebox = function(){
        soundManager.setup({
          url: 'https://cdnjs.cloudflare.com/ajax/libs/soundmanager2/2.97a.20150601/swf/',
          flashVersion: 9,
          preferFlash: false,
          onready: function() {
            loadRandomSong();
          }
        });
        $('#seekBar').on('click', onClickSeekSong)
    }

    var queueSong = function(song){
        queue.push(song);
        displayQueue();
    }

    var unqueueSong = function(index){
        queue.splice(index, 1);
        displayQueue();
    }

    var displayQueue = function() {
        var $div = $('#queuedSongs')
        if(queue.length == 0){
            $div.text('-');
        }else{
            $div.html('');
            for(var i=0; i < queue.length; i++){
                $div.append($('<a>').attr('href', '#')
                                    .text('[x]')
                                    .on('click', (function(index){
                                        return function(ev){
                                            ev.preventDefault();
                                            unqueueSong(index);
                                        }
                                    })(i)))
                    .append(' ')
                    .append($('<a>').attr('href', '#')
                                   .text(queue[i].title)
                                   .attr('title', queue[i].path)
                                   .on('click', function(song){
                                        return function(ev){
                                            ev.preventDefault();
                                            stopSounds();
                                            song.play();
                                        }
                                    }(queue[i])))
                    .append('\n')
            }
        }
    }

    var loadRandomSong = function(){
        $.ajax({
            url: 'api/songs/random',
            method: 'GET',
            dataType: 'json',
            headers: {
              Authorization: 'Token ' + auth_token
            }
        }).done(function(song){
            song = new Song(song.download_url, song.filename, song.has_aac);
            console.log('Loaded random song');
            song.play();
        }).fail(function(e){
            if(e.status == 401){
                askLogin();
            }
        })
    }
    var askLogin = function(){
        $('#login').show();
        $('#jukebox').hide();
    }
    var playNextSong = function(){
        stopSounds();
        if(queue.length > 0){
            queue[0].play();
            unqueueSong(0);
        }else{
            loadRandomSong();
        }
    }

    var onSearchInputChange = function(){
        var query = $('#searchInput').val();
        searchSongs(query);
    }

    var displaySearchResults = function(results){
        $resdiv = $('#searchResults');
        $resdiv.html('');
        for(var i=0; i < results.length; i++){
            $resdiv.append($('<a>').attr('href', '#')
                                   .text('[q]')
                                   .on('click', (function(song){
                                        return function(ev){
                                            ev.preventDefault();
                                            queueSong(song);
                                        }
                                   })(results[i])))
                   .append(' ')
                   .append($('<a>').attr('href', '#')
                                   .text(results[i].title)
                                   .attr('title', results[i].filename)
                                   .on('click', (function(song){
                                        return function(ev){
                                            ev.preventDefault();
                                            stopSounds();
                                            song.play();
                                        }
                                    })(results[i])))
                   .append('\n')
        }
    }

    var searchSongs = function(query){
        $.ajax({
            url: 'api/songs/',
            data: {'q': query},
            method: 'GET',
            dataType: 'json',
            headers: {
              Authorization: 'Token ' + auth_token
            }
        }).done(function(songs){
            console.log('Found '+songs.length+' match');
            results = [];
            for(var i=0; i<songs.length; i++){
                results.push(new Song(songs[i].download_url, songs[i].filename, songs[i].has_aac))
            }
            displaySearchResults(results);
        });
    }

    var onClickSeekSong = function(e){
        console.log('Seek song');
        var perc = e.pageX/$('#seekBar').width();
        var sound_id = soundManager.soundIDs[0];
        var sound = soundManager.getSoundById(sound_id);
        if(sound){
            var target_time = sound.durationEstimate*perc;
            seekSong(target_time);
        }
    }
    
    var seekSong = function(time){
        var sound_id = soundManager.soundIDs[0];
        soundManager.setPosition(sound_id, time);
    }
    
    var promptYoutubeURL = function(){
        var url = window.prompt('Enter a Youtube URL');
        if(url===null){
            return;
        }
        var yt_video_id_re = [
            {pos: 1, re: /^([a-zA-Z0-9_-]{11})$/},
            {pos: 4, re: /^(https?:\/\/)?(www\.|m\.)?youtube\.com\/watch\?(.*&)?v=([a-zA-Z0-9_-]{11})(&.*)?$/},
            {pos: 2, re: /^(https?:\/\/)?youtu\.be\/([a-zA-Z0-9_-]{11})(\?.*)?$/}
        ];
        var video_id = null,
        video_id = yt_video_id_re.map(function(re){
            if(re.re.test(url)){
                return url.match(re.re)[re.pos];
            }
        }).filter(function(el){return !!el})[0];
        if(video_id){
            $.ajax(
                {
                    url: 'submit_yt_download?v='+video_id,
                    type: 'POST'
                }
            ).done(
                function(response){
                    // TODO: track import process
                    console.log('Sent intent to download video '+video_id);
                }
            );
        } else {
            alert('Invalid Youtube URL');
        }
    }
</script>
</body>
</html>
